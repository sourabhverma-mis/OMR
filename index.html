<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Online OMR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:Poppins;
  background:#eef2ff;
  padding:20px;
  display:flex;
  justify-content:center;
}
.wrapper{width:100%;max-width:420px}
.header{text-align:center;margin-bottom:14px}
.header img{height:42px}
.card{
  background:#fff;
  padding:18px;
  border-radius:16px;
  margin-bottom:16px;
  box-shadow:0 10px 20px rgba(0,0,0,.08);
}
label{font-weight:600;margin-top:10px;display:block}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #d1d5ff;
  font-family:Poppins;
}
button{
  background:#4f46e5;
  color:#fff;
  border:none;
  font-weight:600;
  cursor:pointer;
}
button:disabled{background:#a5b4fc}
.qrow{display:flex;gap:10px;margin:8px 0}
.qno{width:42px;font-weight:600}
.bubble{
  width:34px;height:34px;
  border:2px solid #4f46e5;
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.bubble.active{background:#4f46e5;color:#fff}
.bubble.disabled{pointer-events:none;opacity:.5}
#popup{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
}
#box{
  background:#fff;padding:24px;
  border-radius:18px;width:320px;
  text-align:center;
}
</style>
</head>

<body>
<div class="wrapper">

<!-- HEADER -->
<div class="header">
  <img src="https://www.adda247.com/images/header-logo.svg">
</div>

<!-- STUDENT INFO -->
<div class="card">
<h3>üìù Online OMR</h3>

<label>Date</label>
<input id="date" readonly>

<label>Branch</label>
<select id="branch"></select>

<label>Name</label>
<input id="name">

<label>Mobile</label>
<input id="mobile">

<label>Course</label>
<select id="course" onchange="loadTest()">
  <option value="">Select</option>
  <option>SSC</option>
  <option>Bank</option>
  <option>State</option>
  <option>Other</option>
</select>

<label>Test Code</label>
<select id="testCode" onchange="loadQuestions()"></select>
</div>

<!-- TIMER -->
<div class="card">
‚è± Time Left: <b id="timer">30:00</b>
</div>

<!-- QUESTIONS -->
<div class="card" id="questions"></div>

<button id="submitBtn" onclick="submitOMR()">Submit</button>

</div>

<!-- RESULT -->
<div id="popup">
<div id="box">
<h3>üéâ Result</h3>
<p id="rName"></p>
<p>Correct Marks: <b id="rCorrect"></b></p>
<p>Negative Marks: <b id="rNegative"></b></p>
<p>Total Marks: <b id="rTotal"></b></p>
<p>Correct Questions: <b id="rCQ"></b></p>
<p>Incorrect Questions: <b id="rIQ"></b></p>
<p>Attempted: <b id="rAtt"></b></p>
<p>Unattempted: <b id="rUnatt"></b></p>
<button onclick="closeForm()">OK</button>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const API =
"https://script.google.com/macros/s/AKfycbzT4nFskRmYpReAoGrlnLgwy1Z1YKRWpCr7dAQdvqBZnSE-apJGbkYbGDADlX79N5yjSA/exec";

let answers = {};
let time = 1800;
let freezed = false;

/* ================= DATE ================= */
date.value = new Date().toLocaleDateString("en-GB");

/* ================= BRANCH ================= */
fetch(API + "?action=branches")
.then(r=>r.json())
.then(b=>{
  branch.innerHTML =
    "<option></option>" +
    b.map(x=>`<option>${x}</option>`).join("");
});

/* ================= TIMER ================= */
setInterval(()=>{
  if(time < 0 || freezed) return;
  let m=Math.floor(time/60), s=time%60;
  timer.innerText = `${m}:${s<10?'0'+s:s}`;
  time--;
  if(time < 0) submitOMR();
},1000);

/* ================= TEST CODE ================= */
function loadTest(){
  fetch(API + "?action=testCodes&course=" + course.value)
  .then(r=>r.json())
  .then(d=>{
    testCode.innerHTML =
      "<option></option>" +
      d.map(x=>`<option>${x}</option>`).join("");
  });
}

/* ================= QUESTIONS ================= */
function loadQuestions(){
  answers={};
  questions.innerHTML="";
  fetch(API + "?action=meta&testCode=" + testCode.value + "&course=" + course.value)
  .then(r=>r.json())
  .then(meta=>{
    let opts=["A","B","C","D","E"].slice(0,meta.options);
    for(let i=1;i<=meta.totalQ;i++){
      questions.innerHTML+=`
      <div class="qrow">
        <div class="qno">Q${i}</div>
        ${opts.map(o=>`<div class="bubble" onclick="mark(${i},'${o}',this)">${o}</div>`).join("")}
      </div>`;
    }
  });
}

/* ================= MARK ================= */
function mark(q,o,e){
  if(freezed) return;
  answers[q]=o;
  e.parentElement.querySelectorAll(".bubble").forEach(b=>b.classList.remove("active"));
  e.classList.add("active");
}

/* ================= FREEZE ================= */
function freezeAll(){
  freezed=true;
  document.querySelectorAll("input,select,button").forEach(e=>e.disabled=true);
  document.querySelectorAll(".bubble").forEach(b=>b.classList.add("disabled"));
}

/* ================= SUBMIT ================= */
function submitOMR(){
  if(freezed) return;
  freezeAll();

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      branch:branch.value,
      name:name.value,
      mobile:mobile.value,
      course:course.value,
      testCode:testCode.value,
      answers:answers
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="DUPLICATE"){
      alert("Already submitted");
      return;
    }
    rName.innerText=res.name;
    rCorrect.innerText=res.correctMarks;
    rNegative.innerText=res.negativeMarks;
    rTotal.innerText=res.totalMarks;
    rCQ.innerText=res.correctQ;
    rIQ.innerText=res.incorrectQ;
    rAtt.innerText=res.attempted;
    rUnatt.innerText=res.unattempted;
    popup.style.display="flex";
  })
  .catch(()=>alert("Submission failed"));
}

/* ================= CLOSE ================= */
function closeForm(){
  document.body.innerHTML =
    "<h2 style='text-align:center;font-family:Poppins'>‚úÖ Submitted Successfully</h2>";
}
</script>
</body>
</html>
